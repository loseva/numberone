#include "pragma.h"
#include <xc.h>
#include <stdlib.h>
#define lcd_clear() lcd_command(1)
#define lcd_origin() lcd_command(2)
#ifndef _XTAL_FREQ
#define _XTAL_FREQ 10000000 // ??????????? ???????? ???????  40 ???  ??? ??????? __delay_ms
#endif
#define E_pulse_with 50 //???????????? ???????? ????????? LCD ? ???
#define LCD_E PORTDbits.RD3
#define LCD_RS PORTDbits.RD2
#define LCD_Data4 LATD // ????????????? ?????? D4-D7 LCD
void Adc_init()
    {
    TRISA|=0b00101111; //??????? ??????? RA0, RA1, RA2, RA3, RA5 ? ????? ??????
    TRISE|=0b00000111; //??????? ??????? RE0, RE1, RE2 ? ????? ??????
    ADCON1bits.PCFG=0b0111; // ???????????? ???????-???????? ??????
    ADCON1bits.VCFG=0b00; // ??????? ?????????? Vss Vdd
    ADCON2bits.ACQT=0b111;// ????? ?????????????? 20 Tad
    ADCON2bits.ADCS=0b110;// ??????? ?????????????? Fosc/64
    ADCON2bits.ADFM=0;//????? ????????
    ADCON0bits.ADON=1;   // ?????? ??? ???????
     }
int read_Adc(int d)
    {
    ADCON0bits.CHS=d; // ????? ??????????? ??????
    ADCON0bits.GO_DONE=1; // ?????? ??????????????
    while(ADCON0bits.GO_DONE==1);      
    return (ADRESH<<2)+(ADRESL>>6);//?????? ?????????? ??????????????
    }

void lcd_clk(void) /*????????? ???????? ?? ???? EN*/
{
  LCD_E = 1;
  __delay_us(E_pulse_with);
  LCD_E = 0;
  __delay_us(E_pulse_with);
}
void lcd_command(unsigned char outbyte) /*????????? ??????? (4-?????? ??-??? ??????) */
{
  LCD_RS=0; //????? ???????? ???????
  LCD_Data4=(LCD_Data4&0x0f)|(outbyte&0xf0); // ???????? ??????? ??????? ???
  lcd_clk();
  LCD_Data4=(LCD_Data4&0x0f)|((outbyte<<4)&0xf0); // ???????? ??????? ??-????? ???
  lcd_clk();
  __delay_ms(1);
}
void lcd_putc(char outbyte) /* ????????? ?????? (4-?????? ????????) */
{
  LCD_RS=1; //????? ???????? ??????
  LCD_Data4=(LCD_Data4&0x0f)|(outbyte&0xf0);
  lcd_clk();
  LCD_Data4=(LCD_Data4&0x0f)|((outbyte<<4)&0xf0);
  lcd_clk();
}
void lcd_puts(unsigned char line,const char *p) // *????? ?????? ?? ?????*
{
	lcd_origin();         // ??????? ? ???????? ?????? LCD
	lcd_command(line);			// ?????????? ????? LCD 00H
	while(*p)                  // ?????????, ????? ?? ????????? 0
	{
	 lcd_putc(*p);             // ????????? ?????? ?? LCD
	 p++;                      // ????????? ????? ?? 1
	}
}
void inttolcd(unsigned char posi, long value) //????? ?? ????? ???????? ????-??????
{
	char buff[16];
	itoa(buff,value,10);                                                   
	lcd_puts(posi,buff);
}
void lcd_init() // ????????????? LCD-???????
{
  TRISD &= 0x03;// ??????? ??????? RD4-RD7? ????? ???????
  LCD_Data4 &= 0b00001111;//????????? ????? ?? ????? ???????? ??????
  LCD_E=0;
  LCD_RS=0;
  __delay_ms(1);
/*????????????? ???????*/
  LCD_Data4=(LCD_Data4&0x0f)|0x30;
  lcd_clk();
 __delay_ms(1);
  LCD_Data4=(LCD_Data4&0x0f)|0x30;
 lcd_clk();
__delay_ms(1);
  LCD_Data4=(LCD_Data4&0x0f)|0x30;
  lcd_clk();
  __delay_ms(1);
/*---------------------------------*/
  LCD_Data4=(LCD_Data4&0x0f)|0x20;	// ??????????? ?? 4-?????? ????? ??-??-????
  lcd_clk();
  __delay_ms(1);
  lcd_command(0x28);//?????????? N=1, F=0 (??? ??????, ?????? ??????? 5*8 ?????
  lcd_command(0x01);	// ???????? ???
  lcd_command(0x06);	// ????????????? ??????????? ?????? ????? ?????
  lcd_command(0x0C);	// ??????? ???????, ??????? ???, ?? ???????
  lcd_command(0x02);	// ????????? ???????
  lcd_command(0x01);	// ???????? ??? ?????
}
int main(int argc, char** argv)
{
    int i=0, b=0;
TRISA4=1;
int a=0;
Adc_init();
lcd_init();
while(1)
    {
     if (PORTAbits.RA4==0)
    {
     __delay_ms(70);
      if (PORTAbits.RA4==0)
      {
          i+=1;
          
          
      }
            
 }
     if (i>8) i=0;
    
     if(i>0) 
    {
        
   
 b=i-1;
    a = read_Adc(b);
    inttolcd(0x80,ADCON0bits.CHS );
    inttolcd(0xC1,a);
    __delay_ms(70);
//    lcd_clear();
//    a++;
    }
     
     inttolcd(0x86, i);
}
}

     




 
 
    